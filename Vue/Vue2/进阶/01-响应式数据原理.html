<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0"
		/>
		<title>Document</title>
		<style>
			button {
				width: 80px;
				height: 40px;
				background: skyblue;
			}
		</style>
	</head>

	<body>
		<h1 id="h"></h1>

		<button id="add">+1</button>
		<button id="reduce">-1</button>

		<script>
			class Observer {
				constructor(value) {
					Object.defineProperty(value, "__ob__", {
						value: this,
						enumerable: false,
						writable: true,
						configurable: true
					});

					if (Array.isArray(value)) {
						value.__proto__ = arrayMethods;
						this.observeArray(value);
					} else this.walk(value);
				}

				walk(data) {
					Object.keys(data).forEach(key => {
						defineReactive(data, key, data[key]);
					});
				}

				observeArray(items) {
					items.forEach(item => observe(item));
				}
			}

			function defineReactive(data, key, value) {
				observe(value);
				Object.defineProperty(data, key, {
					get() {
						return value;
					},
					set(newValue) {
						const h = document.querySelector("#h");
						h.textContent = newValue;
						if (newValue === value) return;
						value = newValue;
					}
				});
			}

			function observe(value) {
				const type = Object.prototype.toString.call(value);
				if (
					type === "[object Object]" ||
					type === "[object Array]"
				)
					return new Observer(value);
			}

			const arrayProto = Array.prototype;
			const arrayMethods = Object.create(arrayProto);
			const methodsToPatch = [
				"push",
				"pop",
				"shift",
				"unshift",
				"splice",
				"reverse",
				"sort"
			];

			methodsToPatch.forEach(method => {
				arrayMethods[method] = function (...args) {
					const result = arrayProto[method].apply(
						this,
						args
					);
					const ob = this.__ob__;
					let inserted = null;
					switch (method) {
						case "push":
						case "unshift":
							inserted = args;
							break;
						case "splice":
							inserted = args.slice(2);
						default:
							break;
					}
					if (inserted !== null) ob.observeArray(inserted);
					return result;
				};
			});

			const obj = { a: 1 };
			observe(obj);
			console.log(obj);

			add.onclick = () => {
				obj.a++;
				console.log(obj.a);
			};
			reduce.onclick = () => {
				obj.a--;
				console.log(obj.a);
			};
		</script>
	</body>
</html>
